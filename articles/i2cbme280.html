<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rpigpior">
<title>Use I2C for BME280 • rpigpior</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Use I2C for BME280">
<meta property="og:description" content="rpigpior">
<meta property="og:image" content="https://mnr.github.io/rpigpior/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rpigpior</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/R_and_RPi.html">R_and_RPi</a>
    <a class="dropdown-item" href="../articles/gpioCode.html">How to write GPIO Code with rpigpiodr and R</a>
    <a class="dropdown-item" href="../articles/how-to-RPi.html">How to Setup R on Raspberry Pi</a>
    <a class="dropdown-item" href="../articles/i2cbme280.html">Use I2C for BME280</a>
    <a class="dropdown-item" href="../articles/rpi_i2c.html">rpi_i2c</a>
    <a class="dropdown-item" href="../articles/rpi_pwm.html">Raspberry Pi and PWM</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mnr/rpigpior/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Use I2C for BME280</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mnr/rpigpior/blob/HEAD/vignettes/articles/i2cbme280.Rmd" class="external-link"><code>vignettes/articles/i2cbme280.Rmd</code></a></small>
      <div class="d-none name"><code>i2cbme280.Rmd</code></div>
    </div>

    
    
<p>This article shows an example of using <code>rpi_i2c…</code> to
communicate with a BME280 sensor chip.</p>
<div class="section level2">
<h2 id="bme280">BME280<a class="anchor" aria-label="anchor" href="#bme280"></a>
</h2>
<p>The BME280 <a href="https://www.bosch-sensortec.com/media/boschsensortec/downloads/datasheets/bst-bme280-ds002.pdf" class="external-link">(Datasheet)</a>
by Bosch is a versatile integrated environmental sensor designed for
precision measurement of ambient temperature, relative humidity, and
atmospheric pressure. This compact and low-power sensor is equipped with
advanced MEMS (Micro-Electro-Mechanical Systems) technology, providing
accurate and reliable data for various applications, including weather
forecasting, indoor climate control, and IoT devices. Its I2C and SPI
communication interfaces make it easy to interface with microcontrollers
and microprocessors, while its small form factor and energy efficiency
make it an ideal choice for a wide range of projects, from weather
stations to wearable tech, where monitoring and controlling
environmental conditions are paramount.</p>
</div>
<div class="section level2">
<h2 id="wiring-the-bme280">Wiring the BME280<a class="anchor" aria-label="anchor" href="#wiring-the-bme280"></a>
</h2>
<div class="section level3">
<h3 id="illustration-to-come">illustration to come<a class="anchor" aria-label="anchor" href="#illustration-to-come"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="setup-raspberry-pi-for-the-bme280">Setup Raspberry Pi for the BME280<a class="anchor" aria-label="anchor" href="#setup-raspberry-pi-for-the-bme280"></a>
</h2>
<p>Please refer to the <a href="rpi_i2c.Rmd">article</a> on using i2c
with R on the Raspberry Pi. You’ll need to enable I2C (using Raspberry
Pi Configuration) and find the address for the BME280 (using
<code>i2c-tools -y 1</code>)</p>
<p>To confirm the chip is connected and available, use
<code>rpi_i2c_get(chip_address = BME280_location, data_address= 0xD0)</code>.
Depending on the implementation you have purchased, the BME280 may also
appear at chip address 0x76, in which case you would use
<code>rpi_i2c_get(chip_address = 0x76, data_address= 0xD0).</code> This
command should return the BME Chip ID, <code>0x60</code></p>
</div>
<div class="section level2">
<h2 id="preliminary-data-calibration">Preliminary: Data Calibration<a class="anchor" aria-label="anchor" href="#preliminary-data-calibration"></a>
</h2>
<p>The temperature, humidity, and pressure data from the BME280 needs to
be calibrated with other values provided by the BME280. This calibration
algorithm is complex and obfuscates the process of using
<code>rpi_i2c…</code> to read i2c interfaces. In an attempt to separate
calibration from reading data, I’ve chosen to use the original c++
algorithm provided by Bosch Sensortec (shown in the BME280 datasheet)
and use <code>Rcpp</code> to make it available to the R environment.</p>
<p>Calibration requires values obtained from the BME280. These values
can be identified as <code>dig_T1…</code>, <code>dig_H1…</code>, or
<code>dig_P1…</code>followed by <code>_reg</code> (the register location
in hex) or <code>_value</code> (the value at that register). I have
placed the retrieval of these values close to the related function
calls, but these values are stored on the BME280 as non-volatile RAM.
They never change, so if you are looping data acquisition, your
performance will improve if you move i2c calls to these calibration
values outside of the loop.</p>
</div>
<div class="section level2">
<h2 id="read-the-bme280">Read the BME280<a class="anchor" aria-label="anchor" href="#read-the-bme280"></a>
</h2>
<p>The BME280 datasheet provides this flowchart for reading the
sensors.</p>
<div class="figure">
<img src="bme280MeasurementFlow.png" alt=""><p class="caption">BME280 measurement flow from data sheet</p>
</div>
<p>Here is the complete code to read temperature, pressure, and humidity
from the bme280 with i2c. It leans heavily on the source found at <a href="https://github.com/boschsensortec/BME280_driver/blob/master/bme280.c" class="external-link">github.com/boschsensortec</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mnr/rpigpior" class="external-link">rpigpior</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rcpp.org" class="external-link">Rcpp</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">BME280_location</span> <span class="op">&lt;-</span> <span class="fl">0x77</span> <span class="co">#possibly change to 0x76</span></span>
<span></span>
<span><span class="co"># locations of BME280 registers as identified in datasheet</span></span>
<span><span class="va">BME280_id</span> <span class="op">&lt;-</span> <span class="fl">0xD0</span> <span class="co"># 0x60 for BME280</span></span>
<span><span class="va">BME280_reset</span> <span class="op">&lt;-</span> <span class="fl">0xE0</span></span>
<span><span class="va">BME280_ctrl_hum</span> <span class="op">&lt;-</span> <span class="fl">0xF2</span></span>
<span><span class="va">BME280_status</span> <span class="op">&lt;-</span> <span class="fl">0xF3</span></span>
<span><span class="va">BME280_ctrl_meas</span> <span class="op">&lt;-</span> <span class="fl">0xF4</span></span>
<span><span class="va">BME280_config</span> <span class="op">&lt;-</span> <span class="fl">0xF5</span></span>
<span><span class="va">BME280_press</span> <span class="op">&lt;-</span> <span class="fl">0xF7</span> <span class="co"># through 0xF9. _msb, _lsb, _xlsb</span></span>
<span><span class="va">BME280_temp</span> <span class="op">&lt;-</span> <span class="fl">0xFA</span> <span class="co"># through 0xFC. _msb, _lsb, _xlsb</span></span>
<span><span class="va">BME280_hum</span> <span class="op">&lt;-</span> <span class="fl">0xFD</span> <span class="co"># through 0xFE. _msb, _lsb, _xlsb</span></span>
<span></span>
<span><span class="co"># these addresses contain values used in the calibration functions</span></span>
<span><span class="va">dig_T1_reg</span> <span class="op">&lt;-</span> <span class="fl">0x88</span> <span class="co"># these are all 2-byte / 1 word values</span></span>
<span><span class="va">dig_T2_reg</span> <span class="op">&lt;-</span> <span class="fl">0x8A</span></span>
<span><span class="va">dig_T3_reg</span> <span class="op">&lt;-</span> <span class="fl">0x8C</span></span>
<span><span class="va">dig_P1_reg</span> <span class="op">&lt;-</span> <span class="fl">0x8E</span></span>
<span><span class="va">dig_P2_reg</span> <span class="op">&lt;-</span> <span class="fl">0x90</span></span>
<span><span class="va">dig_P3_reg</span> <span class="op">&lt;-</span> <span class="fl">0x92</span></span>
<span><span class="va">dig_P4_reg</span> <span class="op">&lt;-</span> <span class="fl">0x94</span></span>
<span><span class="va">dig_P5_reg</span> <span class="op">&lt;-</span> <span class="fl">0x96</span></span>
<span><span class="va">dig_P6_reg</span> <span class="op">&lt;-</span> <span class="fl">0x98</span></span>
<span><span class="va">dig_H1_reg</span> <span class="op">&lt;-</span> <span class="fl">0xA1</span> <span class="co"># this is one byte</span></span>
<span><span class="va">dig_H2_reg</span> <span class="op">&lt;-</span> <span class="fl">0xE1</span> <span class="co"># this is two bytes</span></span>
<span><span class="va">dig_H3_reg</span> <span class="op">&lt;-</span> <span class="fl">0xE3</span> <span class="co"># this is one byte</span></span>
<span><span class="va">dig_H4_reg</span> <span class="op">&lt;-</span> <span class="fl">0xE4</span> <span class="co"># Erg. This is 11 bits. 1.5 bytes. 0xE4/0xE5[3:0]</span></span>
<span><span class="va">dig_H5_reg</span> <span class="op">&lt;-</span> <span class="fl">0xE5</span> <span class="co"># 0xE5[7:4]/0xE6</span></span>
<span><span class="va">dig_H6_reg</span> <span class="op">&lt;-</span> <span class="fl">0xE7</span> <span class="co"># one byte</span></span>
<span></span>
<span><span class="co"># start measurement cycle ------------------</span></span>
<span><span class="co"># set configuration values</span></span>
<span><span class="va">config_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strtoi.html" class="external-link">strtoi</a></span><span class="op">(</span><span class="st">"01000100"</span>, base <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># t_sb = 125 ms/IIR_filter = on/2 /spi3w_en = off</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rpi_i2c_set.html">rpi_i2c_set</a></span><span class="op">(</span></span>
<span>  chip_address <span class="op">=</span> <span class="va">BME280_location</span>,</span>
<span>  data_address <span class="op">=</span> <span class="va">BME280_config</span>,</span>
<span>  value <span class="op">=</span> <span class="va">config_value</span>,</span>
<span>  data_size <span class="op">=</span> <span class="st">"b"</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># set humidity data acquisition options</span></span>
<span><span class="va">ctrl_hum_value</span> <span class="op">&lt;-</span> <span class="fl">0x01</span> <span class="co"># humidity oversampling set to 1</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rpi_i2c_set.html">rpi_i2c_set</a></span><span class="op">(</span></span>
<span>  chip_address <span class="op">=</span> <span class="va">BME280_location</span>,</span>
<span>  data_address <span class="op">=</span> <span class="va">BME280_ctrl_hum</span>,</span>
<span>  value <span class="op">=</span> <span class="va">ctrl_hum_value</span>,</span>
<span>  data_size <span class="op">=</span> <span class="st">"b"</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># set pressure &amp; temperature data acquisition options</span></span>
<span><span class="va">ctrl_meas_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strtoi.html" class="external-link">strtoi</a></span><span class="op">(</span><span class="st">"00100101"</span>, base <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># osrs_t/osrs_p/mode</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rpi_i2c_set.html">rpi_i2c_set</a></span><span class="op">(</span></span>
<span>   chip_address <span class="op">=</span> <span class="va">BME280_location</span>,</span>
<span>   data_address <span class="op">=</span> <span class="va">BME280_ctrl_meas</span>,</span>
<span>   value <span class="op">=</span> <span class="va">ctrl_meas_value</span>,</span>
<span>   data_size <span class="op">=</span> <span class="st">"b"</span></span>
<span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># read raw temperature ---------------------</span></span>
<span></span>
<span><span class="co"># Use Rcpp to compile the temperature measurement calibration</span></span>
<span><span class="co"># Returns temp in DegC, resolution is 0.01 DegC. </span></span>
<span><span class="co"># Output value of "5123" equals 51.23 DegC</span></span>
<span><span class="fu">cppFunction</span><span class="op">(</span><span class="st">'int BME280_compensate_T_int32(long signed int adc_T, int dig_T1, int dig_T2, int dig_T3)</span></span>
<span><span class="st">{</span></span>
<span><span class="st">long signed int var1, var2, T;</span></span>
<span><span class="st">    Environment env = Environment::global_env();</span></span>
<span><span class="st">    long signed int t_fine = env["t_fine"];</span></span>
<span><span class="st"></span></span>
<span><span class="st">var1 = ((((adc_T&gt;&gt;3) - ((long signed int)dig_T1&lt;&lt;1))) * ((long signed int)dig_T2)) &gt;&gt; 11;</span></span>
<span><span class="st">var2 = (((((adc_T&gt;&gt;4) - ((long signed int)dig_T1)) * ((adc_T&gt;&gt;4) - ((long signed int)dig_T1))) &gt;&gt; 12) *((long signed int)dig_T3)) &gt;&gt; 14;</span></span>
<span><span class="st">t_fine = var1 + var2;</span></span>
<span><span class="st">env["t_fine"] = t_fine;</span></span>
<span><span class="st">T = (t_fine * 5 + 128) &gt;&gt; 8;</span></span>
<span><span class="st">return T;</span></span>
<span><span class="st">}'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read the temperature</span></span>
<span><span class="va">raw_temperature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftL</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">BME280_temp</span>, <span class="st">"w"</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftR</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">BME280_temp</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"b"</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># call the temperature compensation function just compiled</span></span>
<span><span class="va">dig_T1_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_T1_reg</span>, <span class="st">"w"</span><span class="op">)</span></span>
<span><span class="va">dig_T2_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_T2_reg</span>, <span class="st">"w"</span><span class="op">)</span></span>
<span><span class="va">dig_T3_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_T3_reg</span>, <span class="st">"w"</span><span class="op">)</span></span>
<span><span class="va">temperature_celsius</span> <span class="op">&lt;-</span> <span class="fu">BME280_compensate_T_int32</span><span class="op">(</span><span class="va">raw_temperature</span>, <span class="va">dig_T1_value</span>,<span class="va">dig_T2_value</span>,<span class="va">dig_T3_value</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"temperature (c):"</span>, <span class="va">temperature_celsius</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read raw pressure ----------------------</span></span>
<span></span>
<span><span class="co"># Use Rcpp to compile the pressure measurement calibration</span></span>
<span><span class="co"># Returns pressure in Pa as unsigned 32 bit int in Q24.8 format</span></span>
<span><span class="co"># (24 integer bits and 8 fractional bits)</span></span>
<span><span class="co"># Output of "24674867" represents 24674867/256 = 96386.2 Pa</span></span>
<span><span class="fu">cppFunction</span><span class="op">(</span><span class="st">'long unsigned int BME280_compensate_P_int32(long signed int adc_P, int dig_P1, int dig_P2, int dig_P3, int dig_P4, int dig_P5, int dig_P6)</span></span>
<span><span class="st">{</span></span>
<span><span class="st">long long unsigned int var1, var2, p;</span></span>
<span><span class="st">var1 = ((long long unsigned int)t_fine) - 128000;</span></span>
<span><span class="st">var2 = var1 * var1 * (long long unsigned int)dig_P6;</span></span>
<span><span class="st">var2 = var2 + (var1*((long long unsigned int)dig_P5)&lt;&lt;17);</span></span>
<span><span class="st">var2 = var2 + (((long long unsigned int)dig_P4)&lt;&lt;35);</span></span>
<span><span class="st">var1 = ((Var1 * var1 * (long long unsigned int)dig_P3)&gt;&gt;8) + ((Var1 * (long long unsigned int)dig_P2)&lt;&lt;12);</span></span>
<span><span class="st">var1 = (((((long long unsigned int)1)&lt;&lt;47)+var1)) + ((long long unsigned int)dig_P1)&gt;&gt;33;</span></span>
<span><span class="st">if(var1 == 0)</span></span>
<span><span class="st">{</span></span>
<span><span class="st">return 0; // avoid exception caused by division by zero</span></span>
<span><span class="st">}</span></span>
<span><span class="st">p = 1048576-adc_P;</span></span>
<span><span class="st">p = (((p&lt;&lt;31)-var2)*3125)/var1;</span></span>
<span><span class="st">var1 = (((long long unsigned int)dig_P9) * (p&gt;&gt;13) * (p&gt;&gt;13)) &gt;&gt; 25;</span></span>
<span><span class="st">var2 = (((long long unsigned int)dig_P8) * p) &gt;&gt; 19;</span></span>
<span><span class="st">p = ((p  +var1 + var2) &gt;&gt; 8) + (((long long unsigned int)dig_P7)&lt;&lt;4);</span></span>
<span><span class="st">return (long signed int)p;</span></span>
<span><span class="st">}'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raw_pressure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftL</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">BME280_press</span>, <span class="st">"w"</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftR</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">BME280_press</span> <span class="op">+</span> <span class="fl">2</span>, <span class="st">"b"</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pressure</span> <span class="op">&lt;-</span> <span class="fu">BME280_compensate_P_int32</span><span class="op">(</span><span class="va">raw_pressure</span>, </span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_P1_reg</span>, <span class="st">"w"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_P2_reg</span>, <span class="st">"w"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_P3_reg</span>, <span class="st">"w"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_P5_reg</span>, <span class="st">"w"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_P6_reg</span>, <span class="st">"w"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pressure:"</span>, <span class="va">pressure</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read raw humidity ----------------------</span></span>
<span></span>
<span><span class="co"># Use Rcpp to compile the humidity measurement calibration</span></span>
<span><span class="fu">cppFunction</span><span class="op">(</span><span class="st">'long unsigned int BME280_compensate_H_int32(long signed int adc_H, int dig_H1, int dig_H2, int dig_H3, int dig_H4, int dig_H5, int dig_H6) {</span></span>
<span><span class="st">            long signed int v_xl_u32r;</span></span>
<span><span class="st">                Environment env = Environment::global_env();</span></span>
<span><span class="st">    long signed int t_fine = env["t_fine"];</span></span>
<span><span class="st">            </span></span>
<span><span class="st">            v_xl_u32r = (t_fine - ((long signed int)76800));</span></span>
<span><span class="st">            v_xl_u32r = (((((adc_H &lt;&lt; 14) - (((long signed int)dig_H4) &lt;&lt; 20) - (((long signed int)dig_H5) * v_xl_u32r)) + ((long signed int)16384)) &gt;&gt; 15) * (((((((v_xl_u32r * ((long signed int)dig_H6)) &gt;&gt; 10) * (((V_xl_u32r * ((long signed int)dig_H3)) &gt;&gt; 11) + ((long signed int)32768))) &gt;&gt; 10) + ((long signed int)2097152)) * ((long signed int)dig_H2) + 8192) &gt;&gt; 14));</span></span>
<span><span class="st">            V_xl_u32r = (v_xl_u32r - (((((v_xl_u32r &gt;&gt; 15) * v_xl_u32r &gt;&gt; 15)) &gt;&gt; 7 * ((long signed int)dig_H1)) &gt;&gt; 4));</span></span>
<span><span class="st">            v_xl_u32r = (v_xl_u32r &lt; 0 ?0 : v_xl_u32r);</span></span>
<span><span class="st">            v_xl_u32r - (v_xl_u32r &gt; 419430400 : 419430400 : v_xl_u32r;</span></span>
<span><span class="st">            return (long unsigned int) (v_xl_u32r&gt;&gt;12);'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raw_humidity</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">BME280_hum</span>, <span class="st">"w"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 11 bits. 1.5 bytes. 0xE4/0xE5[3:0]</span></span>
<span><span class="va">dig_H4_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftL</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H4_reg</span>, <span class="st">"b"</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwAnd</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H4_reg</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">0x0F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dig_H5_value</span> <span class="op">&lt;-</span> <span class="fu">bitwshiftL</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwAnd</a></span><span class="op">(</span><span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H5_reg</span>, <span class="st">"b"</span><span class="op">)</span>,<span class="fl">0xF0</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H5_reg</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">humidity</span> <span class="op">&lt;-</span> <span class="fu">BME280_compensate_H_int32</span><span class="op">(</span><span class="va">raw_humidity</span>, </span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H1_reg</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H2_reg</span>, <span class="st">"w"</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H3_reg</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>                <span class="va">dig_H4_value</span>,</span>
<span>                <span class="va">dig_H5_value</span>,</span>
<span>                <span class="fu"><a href="../reference/rpi_i2c_get.html">rpi_i2c_get</a></span><span class="op">(</span><span class="va">BME280_location</span>, <span class="va">dig_H6_reg</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"humidity:"</span>, <span class="va">humidity</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mark Niemann-Ross.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
